version: "3"

x-node: &node-common
  depends_on:
    - bootnode
  networks:
    - scratch

services:
  bootnode:
    container_name: bootnode
    build:
      context: .
      dockerfile: ./node.Dockerfile
    command: |
      --nodekeyhex=$BOOTNODEKEY
      --networkid=$NETWORKID
      --netrestrict="172.16.254.0/24"
      --ipcdisable
    networks:
      - scratch

  signer1:
    <<: *node-common
    build:
      context: .
      dockerfile: ./signer.Dockerfile
      args:
        privatekey: $SIGNER1_KEY
        password: $PASSWORD
    container_name: signer1
    command: |
      --bootnodes=$BOOTNODES
      --syncmode="full"
      --password=/.pass
      --unlock=$SIGNER1
      --mine
      --miner.etherbase=$SIGNER1
      --networkid=$NETWORKID
      --netrestrict="172.16.254.0/24"
      --ipcdisable
    volumes:
      - signer1:/root/.ethereum

  signer2:
    <<: *node-common
    build:
      context: .
      dockerfile: ./signer.Dockerfile
      args:
        privatekey: $SIGNER2_KEY
        password: $PASSWORD
    container_name: signer2
    command: |
      --bootnodes=$BOOTNODES
      --syncmode="full"
      --password=/.pass
      --unlock=$SIGNER2
      --mine
      --miner.etherbase=$SIGNER2
      --networkid=$NETWORKID
      --netrestrict="172.16.254.0/24"
      --ipcdisable
    volumes:
      - signer2:/root/.ethereum

  node1:
    <<: *node-common
    build:
      context: .
      dockerfile: ./node.Dockerfile
    container_name: node1-sync
    command: |
      --bootnodes=$BOOTNODES
      --syncmode="full"
      --networkid=$NETWORKID
      --netrestrict="172.16.254.0/24"
      --ipcdisable
    volumes:
      - node1:/root/.ethereum

  node2:
    <<: *node-common
    build:
      context: .
      dockerfile: ./node.Dockerfile
    container_name: node2-rpc
    command: |
      --bootnodes=$BOOTNODES
      --syncmode="full"
      --networkid=$NETWORKID
      --netrestrict="172.16.254.0/24"
      --allow-insecure-unlock
      --http
      --http.addr="0.0.0.0"
      --http.api="admin,eth,net,txpool,debug,personal,web3"
      --http.corsdomain="*"
    ports:
      - 8545:8545
    volumes:
      - node2:/root/.ethereum

volumes:
  signer1:
  signer2:
  node1:
  node2:

networks:
  scratch:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.254.0/24
